<?php


// get newer DOI where a publisher has overwritten old DOI with theirs



function get_redirect($url)
{
	
	$redirect = '';
	
	$ch = curl_init(); 
	curl_setopt ($ch, CURLOPT_URL, $url); 
	curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1); 
	curl_setopt ($ch, CURLOPT_FOLLOWLOCATION,  0); 
	curl_setopt ($ch, CURLOPT_HEADER,		  1);  
	
	// timeout (seconds)
	curl_setopt ($ch, CURLOPT_TIMEOUT, 240);
			
	$curl_result = curl_exec ($ch); 
	
	
	if (curl_errno ($ch) != 0 )
	{
		echo "CURL error: ", curl_errno ($ch), " ", curl_error($ch);
	}
	else
	{
		$info = curl_getinfo($ch);
		
		//print_r($info);
		 
		$header = substr($curl_result, 0, $info['header_size']);
		
		//echo $header;
		
		
		$http_code = $info['http_code'];
		
		if (in_array($http_code, array(301,302,303)) && isset($info['redirect_url']))
		{
			$redirect = $info['redirect_url'];
		}
		
	}
	return $redirect;
}



$dois = array(

'10.2307/2436688',
'10.2307/2435158',
'10.2307/2443347',
'10.2307/2443247',
'10.2307/2442847',
'10.2307/2442773',
'10.2307/2442298',
'10.2307/2435135',
'10.2307/2436435',
'10.2307/2435196',
'10.2307/2435153',
'10.2307/2436703',
'10.2307/2438717',
'10.2307/2440086',
'10.2307/2435165',
'10.2307/2435183',
'10.2307/2436658',
'10.2307/2444608',
'10.2307/2444699',
'10.2307/2435940',
'10.2307/2436160',
'10.2307/2436317',
'10.2307/2435996',
'10.2307/3666506',
'10.2307/2435672',
'10.2307/2435907',
'10.2307/2435404',
'10.2307/2435110',
'10.2307/2436591',
'10.2307/2435264',
'10.2307/3666438',
'10.2307/2435501',
'10.2307/2436412',
'10.2307/2434989',
'10.2307/2440939',
'10.2307/2436215',
'10.2307/2436568',
'10.2307/2436756',
'10.2307/2437040',
'10.2307/2435835',
'10.2307/2436510',
'10.2307/2435384',
'10.2307/2435090',
'10.2307/2436804',
'10.2307/2435466',
'10.2307/2436302',
'10.2307/2435293',
'10.2307/2436679',
'10.2307/2436921',
'10.2307/2436526',
'10.2307/2436575',
'10.2307/2435301',
'10.2307/2436152',
'10.2307/2437034',
'10.2307/3666425',
'10.2307/2435780',
'10.2307/2436243',
'10.2307/2439889',
'10.2307/3755125',
'10.2307/2437108',
'10.2307/2437621',
'10.2307/2437353',
'10.2307/2436820',
'10.2307/2437738',
'10.2307/2437298',
'10.2307/2437639',
'10.2307/2437059',
'10.2307/2437448',
'10.2307/2446525',
'10.2307/2437171',
'10.2307/2436540',
'10.2307/2438168',
'10.2307/2437500',
'10.2307/2437191',
'10.2307/2437610',
'10.2307/3755100',
'10.2307/2437297',
'10.2307/2437540',
'10.2307/2437119',
'10.2307/2437173',
'10.2307/2437474',
'10.2307/2437690',
'10.2307/2438079',
'10.2307/2438785',
'10.2307/2438513',
'10.2307/2439140',
'10.2307/2438426',
'10.2307/2438768',
'10.2307/2438992',
'10.2307/2438791',
'10.2307/2438874',
'10.2307/2438334',
'10.2307/2438179',
'10.2307/2438097',
'10.2307/2437993',
'10.2307/2438408',
'10.2307/2446450',
'10.2307/2438630',
'10.2307/2438363',
'10.2307/2439288',
'10.2307/2437863',
'10.2307/2439266',
'10.2307/2438835',
'10.2307/2441668',
'10.2307/3758166',
'10.2307/3758338',
'10.2307/3758557',
'10.2307/2441303',
'10.2307/2442688',
'10.2307/2442526',
'10.2307/3758829',
'10.2307/2442576',
'10.2307/3758734',
'10.2307/2442264',
'10.2307/2441575',
'10.2307/2441789',
'10.2307/2441847',
'10.2307/3758345',
'10.2307/3758450',
'10.2307/2440785',
'10.2307/2439156',
'10.2307/2440883',
'10.2307/2440228',
'10.2307/2446576',
'10.2307/2439220',
'10.2307/2439224',
'10.2307/2440276',
'10.2307/2439329',
'10.2307/2439525',
'10.2307/2440319',
'10.2307/2440203',
'10.2307/2439905',
'10.2307/2439820',
'10.2307/2440742',
'10.2307/2439553',
'10.2307/2440919',
'10.2307/2440708',
'10.2307/2440066',
'10.2307/2439874',
'10.2307/2439091',
'10.2307/2439864',
'10.2307/2440021',
'10.2307/2440566',
'10.2307/2440620',
'10.2307/2439099',
'10.2307/2437548',
'10.2307/3758331',
'10.2307/2441489',
'10.2307/2445636',
'10.2307/2435144',
'10.2307/2435894',
'10.2307/2440581',
'10.2307/2436146',
'10.2307/2440781',
'10.2307/2445162',
'10.2307/2442043',
'10.2307/2442187',
'10.2307/2441201',

);

foreach ($dois as $doi)
{
	$url = 'https://doi.org/' . $doi;
	
	echo "-- $url\n";
	
	$redirect = get_redirect($url);
	
	if ($redirect != '')
	{
		if (preg_match('/https?:\/\/(dx\.)?doi.org\/(?<doi>.*)$/', $redirect, $m))
		{
			$new_doi = $m['doi'];
			
			echo 'UPDATE names SET old_doi="' . $doi . '", doi="' . $new_doi . '" WHERE doi="' . $doi . '";' . "\n";
		}
	}



}

?>

